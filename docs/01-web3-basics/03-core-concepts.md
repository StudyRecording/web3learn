# 1.3 Web3 核心概念

## 智能合约

### 什么是智能合约

智能合约是**运行在区块链上的程序**，特点是：

- **自动执行**：条件满足时自动执行
- **不可篡改**：部署后代码无法修改
- **去信任**：代码逻辑透明，执行结果可预测

### 智能合约 vs 传统合约

```
传统合约流程
┌────────────┐    ┌────────────┐    ┌────────────┐
│  双方签订  │───>│  律师审核  │───>│  法院执行  │
│  合同     │    │  (可能)    │    │  (违约时)  │
└────────────┘    └────────────┘    └────────────┘
     人为干预         依赖信任          成本高


智能合约流程
┌────────────┐    ┌────────────┐
│  部署合约  │───>│  条件触发  │───> 自动执行
│  到链上    │    │  自动执行  │     (无干预)
└────────────┘    └────────────┘
     代码透明         无需信任          成本低
```

### 简单示例

```solidity
// 简单的众筹智能合约
contract Crowdfund {
    address public owner;           // 项目发起人
    uint256 public goal;            // 目标金额
    uint256 public raised;          // 已筹集金额
    mapping(address => uint256) public contributions; // 每人贡献
    
    constructor(uint256 _goal) {
        owner = msg.sender;
        goal = _goal;
    }
    
    // 捐款
    function contribute() public payable {
        require(msg.value > 0, "Must send ETH");
        contributions[msg.sender] += msg.value;
        raised += msg.value;
    }
    
    // 达成目标后，发起人可提款
    function withdraw() public {
        require(msg.sender == owner, "Only owner");
        require(raised >= goal, "Goal not reached");
        payable(owner).transfer(address(this).balance);
    }
    
    // 未达标时，捐款人可退款
    function refund() public {
        require(raised < goal, "Goal reached");
        uint256 amount = contributions[msg.sender];
        require(amount > 0, "No contribution");
        contributions[msg.sender] = 0;
        payable(msg.sender).transfer(amount);
    }
}
```

## 代币 (Token)

### 同质化代币 (FT - Fungible Token)

同质化 = 可互换，一个代币和另一个完全等价

```
ERC-20 代币标准

┌─────────────────────────────────────────┐
│              ERC-20 方法                 │
├─────────────────────────────────────────┤
│ totalSupply()     总供应量               │
│ balanceOf(addr)   查询余额               │
│ transfer(to, amt) 转账                   │
│ approve(spender, amt) 授权额度           │
│ transferFrom(from, to, amt) 授权转账    │
└─────────────────────────────────────────┘

常见 ERC-20 代币：
├── USDT (泰达币)
├── USDC
├── LINK
└── UNI
```

### 非同质化代币 (NFT - Non-Fungible Token)

非同质化 = 唯一，每个 NFT 都是独特的

```
ERC-721 代币标准

┌─────────────────────────────────────────┐
│              ERC-721 方法                │
├─────────────────────────────────────────┤
│ ownerOf(tokenId)  查询所有者             │
│ transfer(to, tokenId) 转移               │
│ approve(to, tokenId) 授权                │
│ safeTransferFrom(...) 安全转移           │
└─────────────────────────────────────────┘

NFT 应用：
├── 数字艺术 (Bored Ape, CryptoPunks)
├── 游戏道具
├── 域名 (ENS)
├── 会员凭证
└── 数字身份
```

### 代币对比

| 特性 | ERC-20 (FT) | ERC-721 (NFT) |
|------|-------------|---------------|
| 可互换 | 是 | 否 |
| 可分割 | 是 (小数位) | 否 |
| 用途 | 货币、积分 | 收藏品、道具 |
| 示例 | USDT, LINK | BAYC, ENS |

## DeFi (去中心化金融)

### 传统金融 vs DeFi

```
传统金融 (CeFi)
┌─────────────────────────────────────────┐
│                                         │
│  用户 ──存款──> 银行 ──贷款──> 借款人    │
│                  │                      │
│                  ▼                      │
│              银行控制                    │
│              - 利率                     │
│              - 审批                     │
│              - 资金                     │
│                                         │
└─────────────────────────────────────────┘


去中心化金融 (DeFi)
┌─────────────────────────────────────────┐
│                                         │
│  用户A ──存款──> 智能合约 <──借款── 用户B │
│                     │                   │
│                     ▼                   │
│              代码控制                    │
│              - 利率算法                 │
│              - 自动审批                 │
│              - 资金池                   │
│                                         │
└─────────────────────────────────────────┘
```

### DeFi 主要应用

```
DeFi 生态系统

1. 去中心化交易所 (DEX)
   ├── Uniswap: 代币兑换
   ├── Curve: 稳定币兑换
   └── 机制: 自动做市商 (AMM)

2. 借贷协议
   ├── Aave: 借贷平台
   ├── Compound: 借贷平台
   └── 机制: 超额抵押借贷

3. 稳定币
   ├── DAI: 加密资产抵押
   ├── USDC: 法币抵押
   └── 机制: 保持与美元 1:1 锚定

4. 收益聚合器
   ├── Yearn Finance
   └── 机制: 自动寻找最高收益

5. 衍生品
   ├── dYdX: 去中心化永续合约
   ├── GMX
   └── 机制: 链上交易衍生品
```

### AMM 原理 (自动做市商)

```
传统订单簿交易所
买方和卖方匹配订单

买家: 我出 100 USDT 买 1 ETH
卖家: 我卖 1 ETH 要 105 USDT
→ 不匹配，等待...


AMM (自动做市商)
使用流动性池自动定价

┌─────────────────────────────────────────┐
│          流动性池                        │
│                                         │
│   ETH: 100 个                           │
│   USDT: 200,000 个                      │
│                                         │
│   价格 = USDT / ETH = 2000              │
│   恒定乘积: ETH × USDT = 20,000,000     │
└─────────────────────────────────────────┘

买入 1 ETH:
- 新状态: ETH=99, USDT=202,020
- 价格 = 202,020/99 ≈ 2040 (价格上涨)
- 支付约 2,020 USDT
```

## DAO (去中心化自治组织)

### 什么是 DAO

DAO 是通过智能合约运行的组织，决策由代币持有者投票决定。

```
传统公司 vs DAO

传统公司                    DAO
┌─────────────────┐        ┌─────────────────┐
│ CEO 做决策       │        │ 代币持有者投票   │
│ 董事会监督       │   vs   │ 智能合约执行     │
│ 员工执行         │        │ 任何人可参与     │
└─────────────────┘        └─────────────────┘
     中心化                    去中心化
```

### DAO 运作流程

```
DAO 治理流程

1. 提案
   ┌──────────────────────────────────────┐
   │ 任何人可以发起提案                    │
   │ 例如: "拨款 100 ETH 开发新功能"       │
   └───────────────┬──────────────────────┘
                   │
                   ▼
2. 讨论
   ┌──────────────────────────────────────┐
   │ 社区在论坛/Discord 讨论               │
   │ 分析利弊                             │
   └───────────────┬──────────────────────┘
                   │
                   ▼
3. 投票
   ┌──────────────────────────────────────┐
   │ 代币持有者投票                        │
   │ 1 代币 = 1 票                         │
   │ 投票周期: 通常 3-7 天                 │
   └───────────────┬──────────────────────┘
                   │
                   ▼
4. 执行
   ┌──────────────────────────────────────┐
   │ 如果通过，智能合约自动执行            │
   │ 无需人工干预                          │
   └──────────────────────────────────────┘
```

### 知名 DAO

| DAO | 用途 | 治理代币 |
|-----|------|---------|
| Uniswap | DEX 治理 | UNI |
| MakerDAO | DAI 稳定币治理 | MKR |
| Aave | 借贷协议治理 | AAVE |
| ENS | 域名服务治理 | ENS |

## DApp (去中心化应用)

### DApp 架构

```
Web 2.0 应用架构
┌─────────────────────────────────────────┐
│                                         │
│  前端 (React)                           │
│       │                                 │
│       ▼                                 │
│  后端 API (Node.js/Spring)              │
│       │                                 │
│       ▼                                 │
│  数据库 (MySQL/MongoDB)                 │
│       │                                 │
│       ▼                                 │
│  服务器 (AWS/阿里云)                    │
│                                         │
└─────────────────────────────────────────┘


Web 3.0 DApp 架构
┌─────────────────────────────────────────┐
│                                         │
│  前端 (React + ethers.js)               │
│       │                                 │
│       ▼                                 │
│  区块链节点 (Infura/Alchemy)            │
│       │                                 │
│       ▼                                 │
│  智能合约 (区块链上)                     │
│       │                                 │
│       ▼                                 │
│  去中心化存储 (IPFS/Arweave)            │
│                                         │
└─────────────────────────────────────────┘
```

### DApp 特点

```
DApp 特征

1. 开源
   └── 代码公开，可审计

2. 去中心化存储
   └── 数据存储在区块链/IPFS

3. 加密经济激励
   └── 代币激励参与

4. 无单点故障
   └── 分布式运行

5. 用户自主身份
   └── 钱包登录，无需注册
```

### DApp 示例

| DApp | 类型 | 说明 |
|------|------|------|
| Uniswap | DEX | 代币兑换 |
| OpenSea | NFT 市场 | NFT 买卖 |
| Aave | 借贷 | 存借资产 |
| ENS | 域名 | 区块链域名 |
| Snapshot | 治理 | 链下投票 |

## Web3 身份

### 传统身份 vs Web3 身份

```
传统 Web2 身份
┌─────────────────────────────────────────┐
│                                         │
│  Google 账号 ──> Gmail, YouTube...      │
│  微信账号 ───> 微信支付, 小程序...       │
│  支付宝账号 ──> 支付, 芝麻信用...        │
│                                         │
│  问题:                                   │
│  - 身份分散在各个平台                    │
│  - 平台可以封禁账号                      │
│  - 数据被平台控制                        │
│                                         │
└─────────────────────────────────────────┘


Web3 身份
┌─────────────────────────────────────────┐
│                                         │
│  钱包地址 (0x742d...)                   │
│       │                                 │
│       ├──> 访问所有 DApp                │
│       ├──> 持有资产                     │
│       ├──> 链上声誉                     │
│       └──> 完全自主控制                 │
│                                         │
│  优势:                                   │
│  - 一个身份通行 Web3                     │
│  - 无人能封禁                           │
│  - 完全自主                             │
│                                         │
└─────────────────────────────────────────┘
```

### 钱包的作用

```
钱包功能

┌─────────────────────────────────────────┐
│              加密货币钱包                │
├─────────────────────────────────────────┤
│                                         │
│  1. 身份认证                            │
│     └── 签名证明身份                    │
│                                         │
│  2. 资产管理                            │
│     ├── 代币                            │
│     ├── NFT                             │
│     └── 其他链上资产                    │
│                                         │
│  3. 交易签名                            │
│     └── 授权交易执行                    │
│                                         │
│  4. DApp 连接                           │
│     └── 登录和交互                      │
│                                         │
└─────────────────────────────────────────┘

常用钱包:
├── MetaMask (浏览器插件)
├── Rainbow (移动端)
├── Phantom (Solana)
└── Ledger (硬件钱包)
```

## 思考题

1. 智能合约为什么叫"智能"？
2. NFT 和 ERC-20 代币有什么本质区别？
3. DAO 相比传统公司有什么优势和劣势？

## 下一步

[下一节：Web3 技术栈 →](04-tech-stack.md)
